<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜ì–´ ë‹¨ì–´ í…ŒìŠ¤íŠ¸ì§€ ìƒì„±ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tesseract.js OCR ë¼ì´ë¸ŒëŸ¬ë¦¬ (ë¸Œë¼ìš°ì €ìš©) -->
  <script src="https://unpkg.com/tesseract.js@v6.0.0/dist/tesseract.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Noto Sans KR",
        sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: #0f172a;
      color: #e5e7eb;
      text-align: center;
    }

    h1 {
      margin-bottom: 4px;
      font-size: 1.4rem;
    }

    p {
      margin-top: 0;
      margin-bottom: 14px;
      font-size: 0.9rem;
      color: #cbd5f5;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    input[type="file"] {
      color: #e5e7eb;
      font-size: 0.8rem;
      max-width: 230px;
    }

    button {
      padding: 7px 13px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(37, 99, 235, 0.9);
      color: white;
      font-size: 0.8rem;
      cursor: pointer;
    }

    button:hover {
      background: rgba(30, 64, 175, 1);
    }

    #status {
      font-size: 0.85rem;
      margin-top: 6px;
      margin-bottom: 10px;
      color: #e5e7eb;
    }

    #previewWrapper {
      margin: 8px auto 12px;
      max-width: 320px;
    }

    #preview {
      display: none;
      width: 100%;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .raw-box {
      margin: 6px auto 16px;
      max-width: 420px;
      text-align: left;
      font-size: 0.8rem;
      color: #cbd5f5;
    }

    .raw-box textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
      padding: 6px 8px;
      outline: none;
    }

    .raw-box textarea:focus {
      border-color: #60a5fa;
    }

    .mini-btn {
      margin-top: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .mini-btn:hover {
      background: rgba(37, 99, 235, 0.9);
    }

    .date-input {
      margin-bottom: 10px;
      font-size: 0.85rem;
    }

    .date-input input {
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
    }

    /* A4 í…ŒìŠ¤íŠ¸ì§€ ì˜ì—­ */
    #testSheet {
      width: 210mm;
      height: 297mm;
      background: white;
      color: #111827;
      margin: 16px auto;
      border: 1px solid #e5e7eb;
      box-sizing: border-box;
      padding: 0 20mm 20mm 20mm; /* ì¢Œ/ìš°/ì•„ë˜ 2cm */
    }

    #dateRow {
      margin-top: 30mm; /* ìœ„ì—ì„œ 3cm */
      margin-bottom: 20mm; /* ë‚ ì§œì™€ í‘œ ì‚¬ì´ 2cm */
      text-align: center;
      font-size: 11pt;
    }

    #testSheet table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    #testSheet td {
      border: 1px solid #d1d5db;
      height: 8mm; /* ëŒ€ëµ 25ì¤„ ë§ì¶”ê¸° */
      padding: 2px 4px;
      font-size: 10pt;
      vertical-align: middle;
    }

    @page {
      size: A4;
      margin: 0;
    }

    @media print {
      body {
        background: white;
        padding: 0;
      }
      .controls,
      #previewWrapper,
      #status,
      .raw-box,
      .date-input {
        display: none !important;
      }
      #testSheet {
        border: none;
        margin: 0;
        width: 210mm;
        height: 297mm;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸ“˜ ì˜ì–´ ë‹¨ì–´ í…ŒìŠ¤íŠ¸ì§€ ìƒì„±ê¸°</h1>
  <p>ë‹¨ì–´Â·ëœ»ì´ ì íŒ ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ë©´, ëœë¤ í…ŒìŠ¤íŠ¸ì§€ë¥¼ ë§Œë“¤ì–´ A4ë¡œ ì¸ì‡„í•  ìˆ˜ ìˆì–´.</p>

  <div class="controls">
    <input type="file" id="imageInput" accept="image/*" />
    <button id="shuffleBtn">ëœë¤ìœ¼ë¡œ ì„ê¸°</button>
    <button id="ver1Btn">ì˜ì–´ë‹¨ì–´ í…ŒìŠ¤íŠ¸ì§€ (ë²„ì „1)</button>
    <button id="ver2Btn">í•œê¸€í•´ì„ í…ŒìŠ¤íŠ¸ì§€ (ë²„ì „2)</button>
    <button id="printBtn">í”„ë¦°íŠ¸</button>
  </div>

  <div id="status">ğŸ“· ë¨¼ì € ë‹¨ì–´ ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì¤˜.</div>

  <div id="previewWrapper">
    <img id="preview" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" />
  </div>

  <div class="raw-box">
    <div style="margin-bottom:4px;">ğŸ” ì¸ì‹ëœ ì›ë³¸ í…ìŠ¤íŠ¸ (ìë™ ì¶”ì¶œ ê²°ê³¼ í™•ì¸ìš©, í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥)</div>
    <textarea id="rawText" placeholder="ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ë©´ ì—¬ê¸° OCR ê²°ê³¼ê°€ ë³´ì—¬. (í•œ ì¤„ì— 'ì˜ì–´ë‹¨ì–´ í•œê¸€ëœ»' í˜•ì‹ì´ ì¢‹ìŒ)"></textarea>
    <button id="parseBtn" class="mini-btn">í…ìŠ¤íŠ¸ì—ì„œ ë‹¨ì–´ ë‹¤ì‹œ ì½ê¸°</button>
  </div>

  <div class="date-input">
    ì¸ì‡„ë  ë‚ ì§œ:
    <input type="date" id="dateInput" />
  </div>

  <div id="testSheet">
    <!-- JSê°€ ì—¬ê¸°ì— ë‚ ì§œ + í‘œë¥¼ ê·¸ë ¤ì¤Œ -->
  </div>

  <script>
    const imageInput = document.getElementById("imageInput");
    const preview = document.getElementById("preview");
    const statusText = document.getElementById("status");
    const rawText = document.getElementById("rawText");
    const dateInput = document.getElementById("dateInput");
    const testSheet = document.getElementById("testSheet");

    const shuffleBtn = document.getElementById("shuffleBtn");
    const ver1Btn = document.getElementById("ver1Btn");
    const ver2Btn = document.getElementById("ver2Btn");
    const printBtn = document.getElementById("printBtn");
    const parseBtn = document.getElementById("parseBtn");

    let vocabList = [];   // [{ eng: 'apple', kor: 'ì‚¬ê³¼' }, ...]
    let shuffledList = []; // ì„ì¸ ë°°ì—´

    function isHangul(str) {
      return /^[ê°€-í£]+$/.test(str);
    }

    // í•œêµ­ì–´ OCRì—ì„œ 'ì‚¬ ê³¼ë¥¼ ë¨¹ëŠ” ë‹¤' ê°™ì€ ê±¸ 'ì‚¬ê³¼ë¥¼ ë¨¹ëŠ”ë‹¤'ë¡œ ì–´ëŠ ì •ë„ ë³µì›
    function fixKoreanSpacing(str) {
      const tokens = str.split(/\s+/).filter(t => t.length > 0);
      const merged = [];
      for (let i = 0; i < tokens.length; i++) {
        const cur = tokens[i];
        const next = tokens[i + 1];
        if (
          next &&
          isHangul(cur.replace(/[^ê°€-í£]/g, "")) &&
          isHangul(next.replace(/[^ê°€-í£]/g, "")) &&
          (cur.replace(/[^ê°€-í£]/g, "").length === 1 ||
            next.replace(/[^ê°€-í£]/g, "").length === 1)
        ) {
          merged.push(cur + next);
          i++;
        } else {
          merged.push(cur);
        }
      }
      return merged.join(" ");
    }

    // rawTextì— ìˆëŠ” í…ìŠ¤íŠ¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‹¨ì–´/ëœ» ë‹¤ì‹œ íŒŒì‹±
    function parseFromRaw() {
      const text = rawText.value || "";
      const lines = text.split(/\r?\n/);
      const parsed = [];

      for (let line of lines) {
        const trimmed = line.trim();
        if (!trimmed) continue;

        // ë§¨ ì• ì˜ì–´ë‹¨ì–´ ì¶”ì¶œ
        const match = trimmed.match(/^[A-Za-z][A-Za-z'â€™-]*/);
        if (!match) continue;

        const eng = match[0];
        let rest = trimmed.slice(match[0].length).trim();
        if (!rest) continue;

        const kor = fixKoreanSpacing(rest);
        parsed.push({ eng, kor });
      }

      vocabList = parsed;
      shuffledList = [...vocabList];
      statusText.textContent = `âœ… í…ìŠ¤íŠ¸ì—ì„œ ${vocabList.length}ê°œì˜ ë‹¨ì–´/ëœ»ì„ ì½ì–´ ì™”ì–´.`;
    }

    parseBtn.addEventListener("click", () => {
      if (!rawText.value.trim()) {
        alert("í…ìŠ¤íŠ¸ ì°½ì´ ë¹„ì–´ ìˆì–´. ë¨¼ì € ì´ë¯¸ì§€ì—ì„œ ì¸ì‹í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•´ì¤˜!");
        return;
      }
      parseFromRaw();
    });

    imageInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // ë¯¸ë¦¬ë³´ê¸°
      preview.src = URL.createObjectURL(file);
      preview.style.display = "block";

      statusText.textContent = "ğŸ§  ì´ë¯¸ì§€ì—ì„œ ê¸€ìë¥¼ ì¸ì‹ ì¤‘...";

      try {
        const result = await Tesseract.recognize(file, "eng+kor", {
          logger: (m) => {
            if (m.status === "recognizing text") {
              const p = Math.round((m.progress || 0) * 100);
              statusText.textContent = `ì¸ì‹ ì¤‘... ${p}%`;
            }
          },
        });

        const text = result.data.text || "";
        rawText.value = text;

        parseFromRaw();
        statusText.textContent =
          "âœ… ì´ë¯¸ì§€ì—ì„œ ë‹¨ì–´ë¥¼ ì½ì–´ ì™”ì–´. í•„ìš”í•˜ë©´ ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ê³ ì¹œ ë’¤ 'í…ìŠ¤íŠ¸ì—ì„œ ë‹¨ì–´ ë‹¤ì‹œ ì½ê¸°'ë¥¼ ëˆŒëŸ¬ì¤˜.";
      } catch (err) {
        console.error(err);
        statusText.textContent =
          "âš ï¸ ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´. ì´ë¯¸ì§€ ê¸€ìê°€ ë„ˆë¬´ íë¦¬ê±°ë‚˜, ì–¸ì–´ í˜•ì‹ì´ ë‹¤ë¥¼ ìˆ˜ ìˆì–´.";
      }
    });

    function shuffleArray(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    shuffleBtn.addEventListener("click", () => {
      if (vocabList.length === 0) {
        alert("ë¨¼ì € ë‹¨ì–´ê°€ ìˆëŠ” ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ê±°ë‚˜, í…ìŠ¤íŠ¸ì—ì„œ ë‹¨ì–´ë¥¼ ì½ì–´ì¤˜!");
        return;
      }
      shuffledList = shuffleArray(vocabList);
      statusText.textContent = "ğŸ”€ ë‹¨ì–´/ëœ» ìˆœì„œë¥¼ ëœë¤ìœ¼ë¡œ ì„ì—ˆì–´!";
    });

    function makeSheet(version) {
      if (shuffledList.length === 0) {
        alert("ë¨¼ì € ë‹¨ì–´ë¥¼ ì½ê³ (ì´ë¯¸ì§€ or í…ìŠ¤íŠ¸), í•„ìš”í•˜ë©´ ëœë¤ ì„ê¸°ë¥¼ í•´ì¤˜!");
        return;
      }

      const maxItems = Math.min(shuffledList.length, 50); // 25í–‰ Ã— 2ì—´ = 50ê°œ
      const list = shuffledList.slice(0, maxItems);

      const rows = 25;
      const cols = 4; // 1: ë¬¸ì œ, 2: ë‹µì¹¸, 3: ë¬¸ì œ, 4: ë‹µì¹¸

      const selectedDate = dateInput.value;
      const dateStr = selectedDate ? selectedDate : "________";

      let html = "";
      html += `<div id="dateRow">ë‚ ì§œ: ${dateStr}</div>`;
      html += "<table>";

      for (let r = 0; r < rows; r++) {
        html += "<tr>";
        for (let c = 0; c < cols; c++) {
          let cellText = "";
          // 1ë²ˆ/3ë²ˆ ì„¸ë¡œì¤„ì—ë§Œ ë¬¸ì œ(ì˜ë‹¨ì–´ or ëœ»)ë¥¼ ë„£ê³ , 2/4ë²ˆì€ ë¹ˆì¹¸(ë‹µ ì“°ëŠ” ê³µê°„)
          if (c === 0 || c === 2) {
            const baseIndex = c === 0 ? 0 : 25;
            const idx = r + baseIndex;
            if (idx < list.length) {
              const pair = list[idx];
              cellText = version === 1 ? pair.eng : pair.kor;
            }
          } else {
            cellText = ""; // ë‹µ ì ëŠ” ì¹¸
          }
          html += `<td>${cellText}</td>`;
        }
        html += "</tr>";
      }

      html += "</table>";
      testSheet.innerHTML = html;
    }

    ver1Btn.addEventListener("click", () => {
      makeSheet(1); // ì˜ì–´ë‹¨ì–´ë§Œ
      statusText.textContent =
        "âœï¸ ë²„ì „1: ì˜ì–´ ë‹¨ì–´ë§Œ ë“¤ì–´ê°„ í…ŒìŠ¤íŠ¸ì§€ë¥¼ ë§Œë“¤ì—ˆì–´.";
    });

    ver2Btn.addEventListener("click", () => {
      makeSheet(2); // í•œê¸€ ëœ»ë§Œ
      statusText.textContent =
        "âœï¸ ë²„ì „2: í•œê¸€ ëœ»ë§Œ ë“¤ì–´ê°„ í…ŒìŠ¤íŠ¸ì§€ë¥¼ ë§Œë“¤ì—ˆì–´.";
    });

    printBtn.addEventListener("click", () => {
      if (!testSheet.innerHTML.trim()) {
        alert("ë¨¼ì € í…ŒìŠ¤íŠ¸ì§€ë¥¼ ìƒì„±(ë²„ì „1/2 ë²„íŠ¼)í•œ ë’¤ì— í”„ë¦°íŠ¸í•´ì¤˜!");
        return;
      }
      window.print();
    });
  </script>
</body>
</html>
